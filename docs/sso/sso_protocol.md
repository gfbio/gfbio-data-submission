# SSO for gfbio_submissions

### How to get additional user details (i.e. second call)? Description/list of details available.

UserInfo endpunkt: unter Nutzung dieses Endpunkts kann ein Client die beim OP 
verfügbaren Attribute zu einem Benutzer, ebenfalls "Claims" genannt, abfragen.

- OIDC_RP_SCOPES
    - Default:	openid email

- TODO: extend default
- TODO: actually log/output/save encrypted claims from oidc reposones
 

## Notes and glossary

- https://openid.net/connect/

-https://www.heise.de/developer/artikel/OpenID-Connect-Login-mit-OAuth-Teil-1-Grundlagen-2218446.html?seite=all

- https://mozilla-django-oidc.readthedocs.io/en/stable/installation.html

- LOGIN_REDIRECT_URL
    - Default:	/accounts/profile
    - Path to redirect to on successful login. If you don’t specify this, the default Django value will be used.

See also

https://docs.djangoproject.com/en/1.11/ref/settings/#login-redirect-url

- DjangoRestFramework integration available
- possible to change how to connect oidc user indentities to django users
    By default, mozilla-django-oidc looks up a Django user matching the email 
    field to the email address returned in the user info data from the OIDC provider.
- possible to change username generation
- possible to change how users are created (get infos from "claim"(?))
- possible to do advanced user verification based on their claims

https://connect2id.com/learn/openid-connect

Implicit flow -- for browser (JavaScript) based apps that don't have a backend. 
The ID token is received directly with the redirection response from the OP. 
No back-channel request is required here.

Authorisation code flow -- the most commonly used flow, intended for 
traditional web apps as well as native / mobile apps. Involves an initial 
browser redirection to / from the OP for user authentication and consent, 
then a second back-channel request to retrieve the ID token. 
This flow offers optimal security, as tokens are not revealed to the 
browser and the client can also be authenticated.

Hybrid flow -- rarely used, allows the application front-end and back-end to 
receive tokens separately from one another. Essentially a combination of the 
code and implicit flows.

Claims (user info)
OpenID Connect specifies a set of standard claims, or user attributes. 
They are intended to supply the client with consented user details such as 
email, name and picture, upon request. Language tags enable localisation.



- Flow    -	Response Types
- Authorization Code  -  	code
- Implicit    -	id_token

Authorization Code Flow
The authorization code flow returns an authorization code (like it says on 
the tin) that can then be exchanged for an identity token and/or access token. 
This requires client authentication using a client id and secret to retrieve 
the tokens from the back end and has the benefit of not exposing tokens to the
 user agent (i.e. a web browser). This flow allows for long lived access 
 (through the use of refresh tokens). Clients using this flow must be able to 
 maintain a secret.

This flow obtains the authorization code from the authorization endpoint and 
all tokens are returned from the token endpoint.

Implicit Flow
The implicit flow requests tokens without explicit client authentication, 
instead using the redirect URI to verify the client identity. 
Because of this, refresh tokens are not allowed, nor is this flow suitable 
for long lived access tokens. From the client application's point of view, 
this is the simplest to implement, as there is only one round trip to the
 OpenID Connect Provider.

This flow obtains all tokens from the authorization endpoint.

nonce	required	Ein Wert in der von der App erzeugten Anforderung, 
die im resultierenden id_token-Element als Anspruch enthalten ist. 
Die App kann diesen Wert dann überprüfen, um die Gefahr von 
Tokenwiedergabeangriffen zu vermindern. Der Wert ist in der Regel eine 
zufällige, eindeutige Zeichenfolge oder GUID, die verwendet werden kann, 
um den Ursprung der Anforderung zu identifizieren.


To mitigate replay attacks when using the Single-Page Login Flow, 
a cryptographic nonce must be sent on authentication requests as required by 
the OpenID Connect specification.

The nonce is generated by the application, sent as a nonce query string 
parameter in the authentication request, and included in the ID Token 
response from Auth0. This allows applications to correlate the ID Token 
response from Auth0 with the initial authentication request.



My current understanding is as follows:

The client (a web application running in the user's browser) generates a nonce,
 puts it into the browser's session storage, and redirects to the authentication 
 server, passing the nonce as parameter. After authentication, the authentication 
 server redirects back to the client, passing a signed id token containing 
 the nonce, which the client must validate against the nonce from the session storage.

If the nonce is not validated, an attacker could substitute another id token, 
by tricking the user into visiting his site, and sending a redirect with a 
valid id token obtained from a different request.

In addition to the id token, the authentication server also replies with an 
access token. If the nonce is not validated, an attacker could substitute 
a different access token, by tricking the user onto his site, and redirecting 
with that token. This might be used for a client side denial of service attack 
(in particular if browser tabs share the token storage, i.e. use local rather 
than session storage).

In summary, nonce validation is necessary to trust the id token. If the id 
token need not be trusted, nonce validation may be skipped.

### requests of re-login after previous login at gwdg
    
    1.) request:
    
    dev-server/authenticate/ 302
    
    response:
    
    https://sso.gfbio.org/simplesaml/module.php/oidc/authorize.php
    ?scope=openid+email
    &state=i1XWOfvhEdYXMDTJhOZF67qMpa11kR65
    &client_id=_5a9bafe89b8d6b6fd34982130aae08a5c080bf6f75
    &response_type=code
    &redirect_uri=https%3A%2F%2Fc103-171.cloud.gwdg.de%2Foidc%2Fcallback%2F

- response_type Set to code to indicate an authorisation code flow.
- scope Used to specify the scope of the requested authorisation in OAuth. The scope value openid signals a request for OpenID authentication and ID token.
- client_id The client identifier of the RP at the OP. This identifier is assigned when the RP is registered with the OP, via the client registration API, a developer console, or some other method.
- state Opaque value set by the RP to maintain state between request and callback.
- redirect_uri The RP callback URI for the authentication response.

    
    
    2.) request:
    302
    https://sso.gfbio.org/simplesaml/module.php/oidc/authorize.php
    ?scope=openid+email
    &state=i1XWOfvhEdYXMDTJhOZF67qMpa11kR65
    &client_id=_5a9bafe89b8d6b6fd34982130aae08a5c080bf6f75
    &response_type=code
    &redirect_uri=https%3A%2F%2Fc103-171.cloud.gwdg.de%2Foidc%2Fcallback%2F
    
    decoded querystring parameters:
    
    scope: openid email
    state: i1XWOfvhEdYXMDTJhOZF67qMpa11kR65
    client_id: _5a9bafe89b8d6b6fd34982130aae08a5c080bf6f75
    response_type: code
    redirect_uri: https://c103-171.cloud.gwdg.de/oidc/callback/
    
    3.) request:
    302
    
    https://c103-171.cloud.gwdg.de/oidc/callback/
    ?code=def502000a5940d11335f3b1a0bafac9023fedffca26b5da6382e85dd620708e2e93709967232a763e1c8758c3d0efaf2af1bf5365f13e61e344c681e22bc18b3c4ac44fbfb08457b8d938c33301bc517f2c79da4f955249e558f0f4d805842a9706f2d283c21c6ffc7c4d8bd5aefd4e6c39978e05c388e097a194df1a8a16dab7b68dd42530e4e2dafd762c5471d09ccf84c1775d0ad0040e9e435be4c56b1d913a646dd01b46b8dfd49c01f874d2a1012ce09543296eb014e65be3696d01220e3238bab5620a75c7090e61e6aa764987640d62b5ea0e39d029aabe2774221d98ca9614d0202372e3baf1843d45101707339d5639d4926bd9c4eea2d8909e72bb7a46a2d6c2874aff50ba143752514ca2cd2df943ff09ef8e241242abb6b589154af0995155d2266154f70f142e0aeb4a24bc37ac23d0ec34db2372181f96cbb73856fe8e7e452b65fb93217c4ac2449d199df031f736776594f0e96988a065ff3ccf5a04c46d088fd2e06a5f9be3b71102f983b3b80b1cdea21681db022c524697b212323412a6ac92ce6a5983e5aeb340ac8710e6ac8446d11167c3acf271409dc82f42d6ff190df4da44c8860498e9c05927ba7a1864
    &state=i1XWOfvhEdYXMDTJhOZF67qMpa11kR65
    
    decoded querystring parameters:
    
    code: def502000a5940d11335f3b1a0bafac9023fedffca26b5da6382e85dd620708e2e93709967232a763e1c8758c3d0efaf2af1bf5365f13e61e344c681e22bc18b3c4ac44fbfb08457b8d938c33301bc517f2c79da4f955249e558f0f4d805842a9706f2d283c21c6ffc7c4d8bd5aefd4e6c39978e05c388e097a194df1a8a16dab7b68dd42530e4e2dafd762c5471d09ccf84c1775d0ad0040e9e435be4c56b1d913a646dd01b46b8dfd49c01f874d2a1012ce09543296eb014e65be3696d01220e3238bab5620a75c7090e61e6aa764987640d62b5ea0e39d029aabe2774221d98ca9614d0202372e3baf1843d45101707339d5639d4926bd9c4eea2d8909e72bb7a46a2d6c2874aff50ba143752514ca2cd2df943ff09ef8e241242abb6b589154af0995155d2266154f70f142e0aeb4a24bc37ac23d0ec34db2372181f96cbb73856fe8e7e452b65fb93217c4ac2449d199df031f736776594f0e96988a065ff3ccf5a04c46d088fd2e06a5f9be3b71102f983b3b80b1cdea21681db022c524697b212323412a6ac92ce6a5983e5aeb340ac8710e6ac8446d11167c3acf271409dc82f42d6ff190df4da44c8860498e9c05927ba7a1864
    state: i1XWOfvhEdYXMDTJhOZF67qMpa11kR65




### Nonce

#### Settings:

- OIDC_USE_NONCE
- Default:	True
- Controls whether the OpenID Connect client uses nonce verification


- OIDC_NONCE_SIZE
- Default:	32
- Sets the length of the random string used for OpenID Connect nonce verification

## Notes on dev-server setup via OpenIdConnect

### 3rd party

- mozilla-django-oidc==1.2.1

https://mozilla-django-oidc.readthedocs.io/en/stable/installation.html

### set in dev-server.env

- OIDC_RP_CLIENT_ID=...
- OIDC_RP_CLIENT_SECRET=...
- OIDC_RP_SIGN_ALGO=RS256
- OIDC_OP_JWKS_ENDPOINT=https://sso.gfbio.org/simplesaml/module.php/oidc/jwks.php


### local settings excerpt


    OIDC_RP_CLIENT_ID = env('OIDC_RP_CLIENT_ID', default='no_oidc_cl_id')
    OIDC_RP_CLIENT_SECRET = env('OIDC_RP_CLIENT_SECRET',
                                default='no_oidc_cl_secret')
    
    OIDC_RP_SIGN_ALGO = env('OIDC_RP_SIGN_ALGO', default='HS256')
    OIDC_OP_JWKS_ENDPOINT = env('OIDC_OP_JWKS_ENDPOINT', default='no_jwks_url')
    
    OIDC_OP_AUTHORIZATION_ENDPOINT = 'https://sso.gfbio.org/simplesaml/module.php/oidc/authorize.php'
    OIDC_OP_TOKEN_ENDPOINT = 'https://sso.gfbio.org/simplesaml/module.php/oidc/access_token.php'
    OIDC_OP_USER_ENDPOINT = ' https://sso.gfbio.org/simplesaml/module.php/oidc/userinfo.php'
    
    OIDC_USE_NONCE = False  # Default:	True
    
    # TODO: not sure if needed
    LOGIN_REDIRECT_URL = 'https://c103-171.cloud.gwdg.de/'
    LOGOUT_REDIRECT_URL = 'https://c103-171.cloud.gwdg.de/'



### Failed try:

copied Link:
        
        https://c103-171.cloud.gwdg.de/accounts/openid/login/?process=login&openid=https%3A%2F%2Fsso.gfbio.org%2Fsimplesaml%2Fmodule.php%2Foidc%2Fauthorize.php
        
        http://0.0.0.0:8000/accounts/openid/login/?process=login&openid=http%3A%2F%2Fme.yahoo.com

decoded:

        https://c103-171.cloud.gwdg.de/accounts/openid/login/?process=login&openid=https://sso.gfbio.org/simplesaml/module.php/oidc/authorize.php
        
        http://0.0.0.0:8000/accounts/openid/login/?process=login&openid=http://me.yahoo.com     


##### with nonce, as enabled by default

    https://sso.gfbio.org/simplesaml/module.php/oidc/authorize.php?redirect_uri=https%3A%2F%2Fc103-171.cloud.gwdg.de%2Foidc%2Fcallback%2F&nonce=pooEGcidgYeckTQrYzhOf1hqtaNWo4sC&scope=openid+email&state=HMjC5jzofdKpjdFMvziYTiBNrgVafwaY&response_type=code&client_id=_5a9bafe89b8d6b6fd34982130aae08a5c080bf6f75


    https://sso.gfbio.org/simplesaml/module.php/oidc/authorize.php
        ?redirect_uri=https://c103-171.cloud.gwdg.de/oidc/callback/
        &nonce=pooEGcidgYeckTQrYzhOf1hqtaNWo4sC
        &scope=openid+email
        &state=HMjC5jzofdKpjdFMvziYTiBNrgVafwaY
        &response_type=code
        &client_id=_5a9bafe89b8d6b6fd34982130aae08a5c080bf6f75

#### Working:

##### without nonce, disabled by setting

###### 1. start URL
    
    - 302
    - https://c103-171.cloud.gwdg.de/oidc/authenticate/ 

##### redirect to
    
    - 302
    - https://sso.gfbio.org/simplesaml/module.php/oidc/authorize.php?response_type=code&client_id=_5a9bafe89b8d6b6fd34982130aae08a5c080bf6f75&scope=openid+email&redirect_uri=https%3A%2F%2Fc103-171.cloud.gwdg.de%2Foidc%2Fcallback%2F&state=lgpuYgGEiHmcYOwLb9zZ204VMEQHNlU2
    - https://sso.gfbio.org/simplesaml/module.php/oidc/authorize.php
        ?response_type=code
        &client_id=_5a9bafe89b8d6b6fd34982130aae08a5c080bf6f75
        &scope=openid+email
        &redirect_uri=https://c103-171.cloud.gwdg.de/oidc/callback/
        &state=lgpuYgGEiHmcYOwLb9zZ204VMEQHNlU2

##### nicht existierender user

Es wird nach login korrekt zurückgeleitet (auf root url, wie in settings angegeben).
Es ist ein annonymer nutzer "LVDRAXWCHGCF8BCFT2OJY2TAC6K" angemeldet und auch
angelegt, mit unverified email, die der gwdg account email entspricht.

TODO: user creation anpassen    
    
##### Existierender user

Das hier klappte mit gwdg account maweber@mpi-bremen.de, als zur gleichen Zeit auch
ein user mit dieser email auf dem dev server existierte. username maweberSU, superuser.

    https://sso.gfbio.org/simplesaml/module.php/oidc/authorize.php?response_type=code&client_id=_5a9bafe89b8d6b6fd34982130aae08a5c080bf6f75&scope=openid+email&redirect_uri=https%3A%2F%2Fc103-171.cloud.gwdg.de%2Foidc%2Fcallback%2F&state=L8xuC8QTGo73XQ9cIJeld56Oa6lqpogR

    https://sso.gfbio.org/simplesaml/module.php/oidc/authorize.php
        ?response_type=code
        &client_id=_5a9bafe89b8d6b6fd34982130aae08a5c080bf6f75
        &scope=openid+email
        &redirect_uri=https://c103-171.cloud.gwdg.de/oidc/callback/
        &state=L8xuC8QTGo73XQ9cIJeld56Oa6lqpogR




